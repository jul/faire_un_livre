<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="jul" />
  <title>Faire un livre</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="pandoc.css" />
  
</head>
<body>
<header id="title-block-header">
<h1 class="title">Faire un livre</h1>
<p class="author">jul</p>
<p class="date">6 juillet 2024<br />
<span
class="math inline"><em>V</em><em>e</em><em>r</em><em>s</em><em>i</em><em>o</em><em>n</em> : <em>q</em><em>u</em><em>r</em><em>e</em><em>m</em><em>o</em><em>n</em><em>t</em><em>u</em>:</span></p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#pré-requis-et-clonage"
id="toc-pré-requis-et-clonage">Pré-requis et clonage</a>
<ul>
<li><a href="#logiciels-requis-et-optionnels"
id="toc-logiciels-requis-et-optionnels">Logiciels requis et
optionnels</a></li>
<li><a href="#conseil-pour-lédition"
id="toc-conseil-pour-lédition">Conseil pour l’édition</a></li>
</ul></li>
<li><a href="#génération" id="toc-génération">Génération</a></li>
<li><a href="#modifier" id="toc-modifier">modifier</a></li>
<li><a href="#pandoc-et-python-faire-des-filtres"
id="toc-pandoc-et-python-faire-des-filtres">Pandoc et python : faire des
filtres</a>
<ul>
<li><a href="#pandoc-et-lua" id="toc-pandoc-et-lua">Pandoc et lua</a>
<ul>
<li><a
href="#cas-détude-jai-un-tic-de-langage-je-dis-bref-tout-le-temps"
id="toc-cas-détude-jai-un-tic-de-langage-je-dis-bref-tout-le-temps">Cas
d’étude : j’ai un tic de langage je dis « bref » tout le temps</a></li>
<li><a href="#filtre-complexe-avec-mémoire-rajouter-une-liste-des-liens"
id="toc-filtre-complexe-avec-mémoire-rajouter-une-liste-des-liens">Filtre
complexe (avec mémoire) rajouter une liste des liens</a></li>
</ul></li>
</ul></li>
<li><a href="#accessibilité"
id="toc-accessibilité">Accessibilité</a></li>
<li><a href="#versioner" id="toc-versioner">Versioner</a></li>
<li><a href="#références" id="toc-références">Références</a></li>
</ul>
</nav>
<h1 id="introduction">Introduction</h1>
<p>Qui n’a jamais rêvé de pouvoir écrire des choses aux kilomètres dans
une console et se concentrer sur ce que l’on veut dire et non où couper
les mots, le nombre de caractères par lignes et avoir une sortie chiadée
?</p>
<p>Jusqu’à présent la qualité «PAO» était réservé à des logiciels forts
dispendieux, mais, et si on pouvait écrire un livre avec … quasi rien
(si on passe sous silence les 3Gbs d’installation de latex) ?</p>
<p>Comment je me débrouille à partir d’ici ? - pour dupliquer ça chez
moi - comment je le fais fonctionner ? - comment je le modifie ?</p>
<p><a
href="https://github.com/jul/faire_un_livre/blob/main/doc/livre.pdf">Le
résultat généré est ici et le lien visible à la fin dans la liste des
liens</a></p>
<h1 id="pré-requis-et-clonage">Pré-requis et clonage</h1>
<p><a href="https://git-scm.com/downloads">Que vous soyez sous linux ou
windows, mes outils favoris sont inclus quand vous installez le client
git</a>. Surtout sous windows.</p>
<p>L’explorateur de fichier sous windows vous permet dorénavant de faire
un click droit sur un dossier et de faire « git bash here », et vous
allez faire</p>
<pre><code>    git clone https://github.com/jul/faire_un_livre.git
</code></pre>
<p>et maintenant faîtes</p>
<pre><code>    cd faire_un_livre</code></pre>
<p>Dans ce répertoire il y a un fichier : <code>02_quickstart</code> et
bien … c’est celui que vous lisez en ce moment.</p>
<p>Pour les utilisateurs de windows qui vont avoir besoin de latex, je
recommande chaudement l’utilisation de <a
href="https://github.com/ScoopInstaller/Scoop">l’installeur en ligne de
commande scoop pour windows</a> ou <a
href="https://chocolatey.org/install#individual">l’installeur en ligne
de commande choco pour windows</a></p>
<p>D’ailleurs, j’incite tout le monde à se renseigner et/ou modifier ce
texte sur comment installer pandoc et pdflatex qui vont être nécessaires
pour la suite.</p>
<p>Note : que ce soit <em>choco, scoop (windows), pkg (debian) ou apt
(BSD)</em> on installe les logiciels libres en faisant
<code>installer install nom_du paquet</code> et oui installer latex sur
windows peut se faire avec <code>choco install xetex</code>.</p>
<p>Pour FreeBSD, il n’y a pas de package pdflatex il faut installer
texlive et texformats :
<code>pkg install texlive-texmf tex-formats tex-dvipsk</code></p>
<h2 id="logiciels-requis-et-optionnels">Logiciels requis et
optionnels</h2>
<p>Le fichier qui fait la magie d’assembler le texte est
<code>mkdoc.sh</code> il aggrège les fichiers XX_whatever.md ou XX est
un chiffre dans l’ordre et il en fait un livre en utilisant
<code>pandoc</code>.</p>
<p>Comme les autres logiciels il peut être installé avec
<code>choco install pandoc</code>.</p>
<p><a href="http://pandoc.org">Le logiciel pandoc a un site clair mais …
en anglais</a></p>
<p><a href="https://www.jdbonjour.ch/cours/markdown-pandoc/">J’ai pu
trouvé un cours pas dégueu (il semble avoir été donné à l’EPFL) sur le
sujet de pandoc et markdown</a></p>
<p>Normalement, lua (un langage de programmation fort agréable) est
normalement installé comme dépendance de <em>pandoc</em> et sert à faire
des filtres.</p>
<p>Python est en dépendance optionnelle pour faire des filtres avancés
(le générateur de la liste des liens en fin de document) et la
génération de versions. <em>mkdoc.sh</em> s’en passe très bien. Par
contre lui tourne sur bash, donc … on revient à la case intiale :
installez git client qui a 90% des dépendances nécessaires à utiliser le
code source nécessaire à générer le livre.</p>
<h2 id="conseil-pour-lédition">Conseil pour l’édition</h2>
<p>Utilisez un éditeur qui est capable de forcer les retours à la ligne
à 80 colonnes. J’ai vim mon vimrc pour contient :</p>
<pre><code>augroup myformatting
    autocmd Filetype markdown set tw=80
    autocmd BufEnter *md normal ggG&lt;CR&gt;
augroup END</code></pre>
<h1 id="génération">Génération</h1>
<p>Normalement, vous avez bash et vous tapez simplement :</p>
<pre><code>    ./mkdoc.sh</code></pre>
<p>là dans le répertoire <code>doc</code> est apparu
<code>./doc/livre.pdf</code></p>
<p>La magie s’opère ainsi</p>
<ul>
<li>les fichiers terminants par md sont tous mis dans l’ordre
alphabético-numérique dans un gros fichier ;</li>
<li>on leur adjoint un en-tête contenant le titre ;</li>
<li>on leur adjoint la table des contenus automatiquement générée.</li>
</ul>
<p>Il est possible d’ajouter des listes de tableaux et ou des
illustrations.</p>
<h1 id="modifier">modifier</h1>
<p>Le fichier <code>titre_md</code> contient ce qui permet de faire le
titre</p>
<p>Le format des fichiers est en syntaxe « markdown » dont la syntaxe
est documentée ici : <a
href="https://docs.github.com/fr/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax">https://docs.github.com/fr/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax</a></p>
<p>Les fichiers <code>xx_*md</code> sont les fichiers qui composent se
livre.</p>
<p>Pour générer un livre, il suffit d’installer tout les logiciles
nécessaires (tex, latex, pdflatex, pandoc) en plus de ceux que vous avez
déjà, et ensuite <code>./mkdoc.sh</code> vous générera la suite.</p>
<h1 id="pandoc-et-python-faire-des-filtres">Pandoc et python : faire des
filtres</h1>
<p>Alors, pourquoi ne pas utiliser l’excellent pandocfilters et panflute
?</p>
<p>Parce que panflute est plus idiomatiquement proche des filtres lua ou
haskell pour pandoc, et c’est un grand avantage, mais si pandocfilters
est parfait pour faire des filtres simples du type pourt tout élément
faire un truc simple, pour les choses qui nécessitent de modifier le
document <em>genre pour rajouter un index</em> c’est plus compliqué.</p>
<p>Or, en voulant faire un livre qui se voulait accessible, je me suis
aperçu qu’en PDF les liens n’étaient ni visibles, ni leurs URLs. Donc,
comme un grand j’ai décidé de coder mon propre filtre.</p>
<p>Deux choses aident :</p>
<ul>
<li><a href="https://pandoc.org/filters.html">la documentation de pandoc
est claire quoique concise</a></li>
<li><a
href="https://stackoverflow.com/questions/tagged/pandoc?tab=Votes">on
trouve beaucoup de question réponses sur pandoc sur
stackoverflow</a></li>
</ul>
<h2 id="pandoc-et-lua">Pandoc et lua</h2>
<p>Lua est un langage de programmation clair assez basique avec lequel
il est dur de se tirer une balle dans le pied.</p>
<p>Sa syntaxe qui rappelle un peu pascal (function/if//end, et les index
de tableau à 1) n’est pas sans déplaire.</p>
<p>Un filtre lua simple est un filtre qui pour un type d’objet pandoc
(tel qu’exposé dans la sortie JSON) fait correspondre une manipulation
simple.</p>
<h3 id="cas-détude-jai-un-tic-de-langage-je-dis-bref-tout-le-temps">Cas
d’étude : j’ai un tic de langage je dis « bref » tout le temps</h3>
<p>PROUT je ne veux plus voir « bref » dans mes sorties !</p>
<p>le filtre lua suivant que l’on enregistra dans bref.lua :</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> Str <span class="op">(</span><span class="va">el</span><span class="op">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="va">el</span><span class="op">.</span><span class="va">text</span><span class="op">:</span><span class="fu">match</span> <span class="st">&#39;Bref&#39;</span> <span class="cf">then</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;PROUT&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div>
<p>Retourne PROUT à chaque fois qu’il voit « PROUT » seul.</p>
<p>On l’appelle dans la chaîne de production avec
<code>pandoc --lua-filter bref.lua input.whatever -o output.peu_importe</code></p>
<h3
id="filtre-complexe-avec-mémoire-rajouter-une-liste-des-liens">Filtre
complexe (avec mémoire) rajouter une liste des liens</h3>
<p>Le PDF c’est bien, c’est cliquable.</p>
<p>Mais, quand on imprime un PDF, les liens deviennent invisible … si
seulement on pouvait rajouter une table de lien avec
<em>panflute</em>.</p>
<p><a href="https://scorreia.com/software/panflute/">Panflute est un
module python bien documenté pour faire des filtres pandoc</a> et
l’exemple qui suit est dérivé directement du code d’exemple :</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> panflute <span class="im">import</span> <span class="op">*</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>toc <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare(doc):</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> toc</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    toc <span class="op">=</span> DefinitionList()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> action(elem, doc):</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> toc</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(elem, Link):</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        _def <span class="op">=</span> elem.url</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        item <span class="op">=</span>  DefinitionItem([ </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>            Str(_def)],</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            Definition(</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>                Plain(</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                    Str(</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f&quot;</span><span class="sc">{</span>stringify(elem.content)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>            )))], )</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        toc.content.insert(<span class="op">-</span><span class="dv">1</span>,item)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> finalize(doc):</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    ttoc <span class="op">=</span> Div(</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        Header(Str(<span class="st">&quot;Liste des liens&quot;</span>)),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        toc</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    doc.content<span class="op">+=</span>  [ ttoc ]</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main(doc<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> run_filter(action, prepare<span class="op">=</span>prepare, finalize<span class="op">=</span>finalize, doc<span class="op">=</span>doc)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div>
<h1 id="accessibilité">Accessibilité</h1>
<p>En sortant, l’autre jour, je suis tombé sur quelqu’un qui aurait bien
aimé lire, une épreuve faite avec ce gabarit, mais … La fonte et sa
taille n’aidait pas.</p>
<p>Je me dis que ce serait bien qu’en tant qu’informaticien, j’essaie
d’aider un peu donc j’ai fait mes recherche et j’ai rajouté une sortie
avec une <a href="https://brailleinstitute.org/freefont">fonte conçue
par l’institut braille</a> pour faciliter la lecture pour les
dys-voyants et mal-voyants.</p>
<p>Fonte qu’il va vous falloir télécharger et installer si vous voulez
générer le livre en format « lisible ».</p>
<h1 id="versioner">Versioner</h1>
<p>La commande <em>versioner.sh</em> va introduire une chaîne aléatoire
qui tente d’être prononçable après la date sur la couverture.</p>
<p>Cela permet à ceux qui utilisent un gestionnaire de version comme moi
de pouvoir remonter dans le passer faire les corrections et envoyer un
cout de <em>git rebase -i</em> pour propager les corrections faîtes sur
une ancienne version.</p>
<p>Le fichier history.txt donne le hash de la révision git correspondant
au commit précédent l’introduction de la version. Ça marque la révision
qui vient d’être révolue.</p>
<h1 id="références">Références</h1>
<ul>
<li>syntaxe bash <a
href="https://tldp.org/LDP/abs/html/">https://tldp.org/LDP/abs/html/</a></li>
<li>le site officiel de pandoc <a
href="https://pandoc.org/">https://pandoc.org/</a></li>
<li>la documentation markdown <a
href="https://docs.github.com/fr/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax">https://docs.github.com/fr/get-started/writing-on-github/getting-started-with-writing-and-formatting-on-github/basic-writing-and-formatting-syntax</a></li>
<li>le site où trouver ce livre et comment le fabriquer <a
href="https://github.com/jul/faire_un_livre">https://github.com/jul/faire_un_livre</a></li>
</ul>
</body>
</html>
